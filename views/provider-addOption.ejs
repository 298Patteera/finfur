<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เพิ่มตัวเลือก | FINFUR</title>
    <link rel="icon" type="image/png" href="/images/logo_main.png">
    <link rel="stylesheet" href="/public/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="navbarContainer">
        <div id="defaultNavbar">
            <%- include('partials/narbar') %>
        </div>
        <div id="searchNavbar" style="display: none;">
            <%- include('partials/narbar_search') %>
        </div>
    </div>
    
    <div class="max-w-6xl mx-auto mt-10 bg-white shadow-lg rounded-lg p-5">
        <%- include('partials/menu_for_provider') %>
        <script>
            function searchProductsPvd() {
                const productID = document.getElementById('productID').value.toLowerCase();
                const searchResultsPvd = document.getElementById('searchResultsPvd');
                const resultItems = searchResultsPvd.querySelectorAll('li');
                
                if (productID === "") {
                    searchResultsPvd.style.display = "none";
                } else {
                    searchResultsPvd.style.display = "block";
                    resultItems.forEach(item => {
                        const itemID = item.getAttribute('data-id').toLowerCase();
                        
                        if (itemID.includes(productID)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                }

            }

        </script>
        
        <div class="space-y-6">
            <!-- ค้นหาสินค้า -->
            <div class="flex items-start space-x-6">
                <div class="w-full relative">
                    <br>
                    <label for="productID" class="block text-gray-700 font-semibold mb-2">กรอกรหัสสินค้าที่ต้องการเพิ่มตัวเลือก</label>
                    <input type="text" id="productID" placeholder="รหัสสินค้า 5 หลัก" 
                        class="block w-full px-4 py-2 mt-2 bg-gray-100 rounded-md focus:ring focus:ring-indigo-300"
                        onkeyup="searchProductsPvd()">
                    <div id="searchResultsPvd" class="mt-1 border border-gray-300 bg-white w-full max-w-sm absolute z-10 hidden">
                        <ul class="max-h-60 overflow-y-auto">
                            <% idName.forEach(function(item) { %>
                                <li class="border-b p-2 hover:bg-gray-100 cursor-pointer" 
                                    data-id="<%= item.productID %>" 
                                    data-name="<%= item.productName %>"
                                    data-brand="<%= item.brand %>">
                                    <%= item.productID %> <%= item.productName %>
                                </li>
                            <% }); %>
                        </ul>
                    </div>
        
                    <input type="text" id="productName" placeholder="ชื่อสินค้า" 
                        class="block w-full px-4 py-2 mt-2 rounded-md focus:ring focus:ring-indigo-300"
                        readonly style="display: none;">
                </div>
        
                <!-- รูปสินค้าที่ค้นหา -->
                <div class="mt-6 w-40 h-30 bg-gray-100 flex items-center justify-center rounded-md overflow-hidden">
                    <img src="/images/allProduct/1.png" alt="searchedProduct" id="searchedProduct"
                        onerror="this.style.display='none'" class="object-cover w-full h-full">
                </div>
            </div>
        
            <!-- รายการตัวเลือก -->
            <div>
                <p class="text-gray-700 font-semibold mb-2">รายการตัวเลือกของสินค้า</p>
                <div class="bg-blue-100 p-4 rounded-md">
                    <div class="grid grid-cols-[2fr_2fr_2fr_auto] gap-4 font-semibold text-gray-700 px-4 py-2">
                        <span>ประเภทของตัวเลือกสินค้า</span>
                        <span>ตัวเลือกสินค้า</span>
                        <span>ราคาบวกเพิ่ม</span>
                        <span></span>
                    </div>
            
                    <div id="optionsContainer">
                        <% product.forEach(item => { %>
                            <div class="grid grid-cols-[2fr_2fr_2fr_min-content] gap-3 p-1 rounded-md product-option"
                                data-product-id="<%= item.productID %>" style="display: none;">
                                <input value="<%= item.optionType %>" type="text" placeholder="ประเภทตัวเลือก" class="bg-blue-100 px-2 py-1 border rounded-md w-full" readonly>
                                <input value="<%= item.optionName %>" type="text" placeholder="ตัวเลือกสินค้า" class="bg-blue-100 px-2 py-1 border rounded-md w-full" readonly>
                                <input value="<%= item.addPrice %>" type="text" placeholder="ราคาบวกเพิ่ม" class="bg-blue-100 px-2 py-1 border rounded-md w-full" readonly>
                                <button 
                                    data-productID="<%= item.productID %>" 
                                    data-optionType="<%= item.optionType %>" 
                                    data-optionName="<%= item.optionName %>"
                                    data-addPrice="<%= item.addPrice %>"
                                    class="action-btn bg-red-500 hover:bg-red-400 text-white px-4 py-2 rounded-md">
                                    ลบ
                                </button>
                            </div>
                        <% }) %>
                    </div>
                    
            
                    <button id="addOptionBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded-md w-full">
                        เพิ่มตัวเลือก
                    </button>
                </div>
            </div>


    <script>

        document.getElementById('addOptionBtn').addEventListener('click', function() {
                let container = document.getElementById('optionsContainer');

                let row = document.createElement('div');
                row.className = "grid grid-cols-[2fr_2fr_2fr_min-content] gap-3 p-1 rounded-md product-option";

                let typeInput = document.createElement('input');
                typeInput.type = "text";
                typeInput.placeholder = "ประเภทตัวเลือก";
                typeInput.className = "px-2 py-1 border rounded-md w-full ";

                let optionInput = document.createElement('input');
                optionInput.type = "text";
                optionInput.placeholder = "ตัวเลือกสินค้า";
                optionInput.className = "px-2 py-1 border rounded-md w-full";

                let addPricenput = document.createElement('input');
                addPricenput.type = "text";
                addPricenput.placeholder = "ราคาบวกเพิ่ม";
                addPricenput.className = "px-2 py-1 border rounded-md w-full";

                let actionBtn = document.createElement('button');
                actionBtn.className = "action-btn bg-green-500 hover:bg-green-400 text-white px-4 py-2 rounded-md";
                actionBtn.innerText = "ยืนยัน";
                let productID = document.getElementById('productID').value;
                actionBtn.setAttribute('data-productID', productID);


                actionBtn.addEventListener('click', function() {
                    if (actionBtn.innerText === "ยืนยัน") {
                        actionBtn.innerText = "ลบ";
                        actionBtn.className = "action-btn bg-red-500 text-white px-4 py-2 rounded-md";
                    } else {
                        row.remove();
                    }
                });
                row.appendChild(typeInput);
                row.appendChild(optionInput);
                row.appendChild(addPricenput);
                row.appendChild(actionBtn);
                container.appendChild(row);
            });

            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (btn.innerText === "ยืนยัน") {
                        btn.innerText = "ลบ";
                        btn.className = "action-btn bg-red-500 text-white px-4 py-2 rounded-md";
                    } else {
                        btn.parentElement.remove();
                    }
                });
            });

        async function addProduct() {
            let productData = getData();
            if (!productData) return;

            try {
                let response = await fetch('/add-to-productlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                let result = await response.json();
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('❗' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ไม่สามารถเพิ่มสินค้าได้');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const searchResultsPvd = document.getElementById('searchResultsPvd');
            const options = document.querySelectorAll('.product-option');
                searchResultsPvd.addEventListener('click', function(e) {
                    if (e.target && e.target.tagName === 'LI') {
                        const productID = e.target.getAttribute('data-id');
                        const productName = e.target.getAttribute('data-name');
                        const productBrand = e.target.getAttribute('data-brand');

                        console.log("clicked", productID)
            
                        document.getElementById('productID').value = productID;
                        document.getElementById('productName').value = productName + " / " + productBrand;
                        document.getElementById('productName').style.display = '';

                        const productImg = document.getElementById('searchedProduct')
                        productImg.src = "/images/allProduct/"+productID+".png";
                        productImg.style.display = '';

                        searchResultsPvd.style.display = 'none'; 

                        options.forEach(option => {
                        const optionProductID = option.getAttribute('data-product-id');
                        if (optionProductID === productID) {
                            option.style.display = "grid";
                        } else {
                            option.style.display = "none";
                        }
                    });
                    }
                });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เพิ่มสินค้า | FINFUR</title>
    <link rel="icon" type="image/png" href="/images/logo_main.png">
    <link rel="stylesheet" href="/public/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="navbarContainer">
        <div id="defaultNavbar">
            <%- include('partials/narbar') %>
        </div>
        <div id="searchNavbar" style="display: none;">
            <%- include('partials/narbar_search') %>
        </div>
    </div>
    
    <div class="max-w-6xl mx-auto mt-10 bg-white shadow-lg rounded-lg p-5">
        <%- include('partials/menu_for_provider') %>
        <%- include('partials/categoryDropdown_for_provider') %>
        
        <table class="mt-6 w-full border">
            <thead>
                <tr class="bg-blue-100">
                    <th class="border p-2">หมวดหมู่</th>
                    <th class="border p-2">รหัสสินค้า (5 หลัก)</th>
                    <th class="border p-2">ชื่อสินค้า</th>
                    <th class="border p-2">ราคา</th>
                    <th class="border p-2">จำนวนที่ต้องการเพิ่ม/ลด</th>
                </tr>
            </thead>
            <tbody id="productTable">
                <tr>
                    <td class="border p-2">
                        <select id="categorySelect" class="w-full border">
                            <% Object.entries(categories).forEach(([categoryID, category]) => { %>
                                <optgroup label="<%= category.categoryName %>">
                                    <% Object.entries(category.subCategories).forEach(([subID, subName]) => { %>
                                        <option value="<%= categoryID %><%= subID %>"><%= subName %></option>
                                    <% }); %>
                                </optgroup>
                            <% }); %>
                        </select>
                    </td>
                    <td class="border p-2"><input type="text" id="productID" class="w-full border"></td>
                    <td class="border p-2"><input type="text" id="productName" class="w-full border"></td>
                    <td class="border p-2"><input type="number" id="productPrice" class="w-full border"></td>
                    <td class="border p-2"><input type="number" id="productQuantity" class="w-full border"></td>
                </tr>
            </tbody>
        </table>
        
        <div class="flex mt-4 space-x-4">
            <button class="bg-red-600 text-white px-4 py-2 rounded" onclick="delProduct()">ลบสินค้า</button>
            <button class="bg-green-600 text-white px-4 py-2 rounded" onclick="addProduct()">เพิ่มสินค้า</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let categorySelect = document.getElementById('categorySelect');
            let productIDInput = document.getElementById('productID');
            
            categorySelect.addEventListener('change', function() {
                let selectedValue = this.value;
                productIDInput.value = selectedValue;
            });
        });
        async function addProduct() {
            let productData = getData();
            if (!productData) return;

            try {
                let response = await fetch('/add-to-productlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                let result = await response.json();
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('❗' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ไม่สามารถเพิ่มสินค้าได้');
            }
        }

        async function delProduct() {
            let productData = getData();
            if (!productData) return;

            try {
                let response = await fetch('/del-to-productlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                let result = await response.json();
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('❗' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ไม่สามารถลดสินค้าได้');
            }
        }

        function getData() {
            let productID = document.getElementById('productID').value.trim();
            let name = document.getElementById('productName').value.trim();
            let categoryID = parseInt(document.getElementById('categorySelect').value.substring(0, 1), 10);
            let subID = parseInt(document.getElementById('categorySelect').value.substring(1), 10);
            let price = parseFloat(document.getElementById('productPrice').value);
            let stockNum = parseInt(document.getElementById('productQuantity').value, 10);

            if (!productID || !name || isNaN(categoryID) || isNaN(subID) || isNaN(price) || isNaN(stockNum)) {
                alert('กรุณากรอกข้อมูลให้ครบทุกช่อง');
                return null;
            }

            function ThaiDate() {
                const date = new Date();
                const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Bangkok' };
                return new Intl.DateTimeFormat('th-TH', options).format(date);
            }

            let modifiedTimestamp = ThaiDate();

            return {
                productID: productID,
                productName: name,
                categoryID: categoryID,
                subID: subID,
                price: price,
                stockNum: stockNum,
                modifiedTimestamp: modifiedTimestamp
            };
        }

    </script>
</body>
</html>
